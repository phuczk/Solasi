<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch B√†i H√°t Spotify</title>
    <link rel="stylesheet" href="style_index.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  </head>

  <body>
    
    <div class="sidebar">
      <h2>üìñ Solasi </h2>
      <ul>
          <li><a href="../daily_task/daily_task.html" title="Nhi·ªám V·ª• H√†ng Ng√†y">üìÖ Nhi·ªám V·ª• H√†ng Ng√†y</a></li>
          <li><a href="../play_list/playlist.html" title="Xem Playlist">üéµ Xem Playlist</a></li>
      </ul>
  </div>
  
  
  

    <!-- N·ªôi dung ch√≠nh b√™n ph·∫£i -->
    <div class="main-content">
      


      <div class="banner-container">
        <div class="banner-slide" id="banner1">
          <img src="https://www.shutterstock.com/shutterstock/photos/1597115659/display_1500/stock-vector-music-festival-banner-background-template-with-colorful-trend-colors-poster-for-print-material-1597115659.jpg" alt="Banner 1">
        </div>
        <div class="banner-slide" id="banner2">
          <img src="https://thietkewebchuyen.com/wp-content/uploads/thiet-ke-banner-website-anh-bia-Facebook-am-nhac-1.jpg" alt="Banner 2">
        </div>
        <div class="banner-slide" id="banner3">
          <img src="https://thietkewebchuyen.com/wp-content/uploads/thiet-ke-banner-website-anh-bia-Facebook-am-nhac-4.jpg" alt="Banner 3">
        </div>
      </div>

      
      
      <div class="search-container">
        <div class="search-bar">
          <input 
            type="text" 
            placeholder="T√¨m ki·∫øm b√†i h√°t, ngh·ªá sƒ©, album..." 
            class="search-input" 
            id="searchQuery"
          />
          <button id="searchButton" class="search-btn">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
      

      

      <!-- Form t√¨m ki·∫øm b√†i h√°t
      <div class="search-form">
        <input
          type="text"
          id="searchQuery"
          placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..."
          required
        />
        <button id="searchButton">T√¨m Ki·∫øm</button>
      </div> -->

      <!-- Th√¥ng b√°o tr·∫°ng th√°i -->
      <div id="status" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="message">
        
      </div>

      <!-- Danh s√°ch b√†i h√°t -->
      <div class="track-list-container">
        <ul id="tracksList" class="tracks-list" style="display: none"></ul>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const clientId = "7edacf5546fa4bb58e20f54e69e47079";
        const clientSecret = "e538099ccc6b4da38cf1723b74542411";
        const apiUrl = "https://api.spotify.com/v1/search";
        const tokenUrl = "https://accounts.spotify.com/api/token";
        
        const statusDiv = document.getElementById("status");
        const messageDiv = document.getElementById("message");
        const tracksList = document.getElementById("tracksList");
        const searchButton = document.getElementById("searchButton");
        const searchQueryInput = document.getElementById("searchQuery");

        let accessToken = "";
        let currentQuery = "";
        let offset = 0;
        const limit = 20;
        let isLoading = false;
        let hasMore = true;

        async function getAccessToken() {
          const credentials = `${clientId}:${clientSecret}`;
          const encodedCredentials = btoa(credentials);

          try {
            const response = await fetch(tokenUrl, {
              method: "POST",
              headers: {
                Authorization: `Basic ${encodedCredentials}`,
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: "grant_type=client_credentials",
            });

            if (response.ok) {
              const data = await response.json();
              accessToken = data.access_token;
              console.log("Access Token:", accessToken);
              if (currentQuery === "") {
                loadMoreTracks();
              }
            } else {
              const errorData = await response.json();
              throw new Error(
                `Failed to get access token: ${response.status} - ${
                  errorData.error_description || response.statusText
                }`
              );
            }
          } catch (error) {
            console.error("Error fetching access token:", error);
            showMessage("ƒê√£ x·∫£y ra l·ªói khi l·∫•y Access Token.", "error");
          }
        }

        async function searchTracks(query, newSearch = true) {
          if (!accessToken) {
            showMessage("Access Token kh√¥ng h·ª£p l·ªá.", "error");
            return;
          }

          if (newSearch) {
            offset = 0;
            hasMore = true;
            tracksList.innerHTML = "";
          }

          if (!hasMore) return;

          isLoading = true;
          showLoading(true);

          try {
            const response = await fetch(
              `${apiUrl}?q=${encodeURIComponent(query)}&type=track&limit=${limit}&offset=${offset}`,
              {
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                },
              }
            );

            if (response.ok) {
              const data = await response.json();
              const tracks = data.tracks.items.filter((track) => track.preview_url);
              displayTracks(tracks);
              offset += limit;
              hasMore = tracks.length === limit;
            } else {
              const errorData = await response.json();
              throw new Error(
                `Failed to fetch tracks: ${response.status} - ${errorData.error.message}`
              );
            }
          } catch (error) {
            console.error("Error fetching tracks:", error);
            showMessage("ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch b√†i h√°t.", "error");
          } finally {
            isLoading = false;
            showLoading(false);
          }
        }

        function displayTracks(tracks) {
          if (tracks.length === 0 && offset === 0) {
            showMessage("Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o c√≥ b·∫£n xem tr∆∞·ªõc.", "error");
            tracksList.style.display = "none";
            return;
          }

          tracks.forEach((track) => {
            const listItem = document.createElement("li");
            listItem.className = "track-item";

            const albumImage = document.createElement("img");
            albumImage.src = track.album.images[0]?.url || "https://via.placeholder.com/60";
            albumImage.alt = track.name;
            albumImage.className = "track-image";
            listItem.appendChild(albumImage);

            const trackInfo = document.createElement("div");
            trackInfo.className = "track-info";

            const trackName = document.createElement("a");
            trackName.href = `../detail/detail.html?id=${track.id}`;
            trackName.textContent = track.name;
            trackName.className = "track-name";
            trackInfo.appendChild(trackName);

            const artists = track.artists.map((artist) => artist.name).join(", ");
            const trackArtists = document.createElement("div");
            trackArtists.textContent = artists;
            trackArtists.className = "track-artists";
            trackInfo.appendChild(trackArtists);

            listItem.appendChild(trackInfo);
            tracksList.appendChild(listItem);
          });

          tracksList.style.display = "block";
        }

        function showMessage(message, type) {
          messageDiv.textContent = message;
          messageDiv.className = type === "success" ? "success" : "error-message";
          setTimeout(() => {
            messageDiv.textContent = "";
            messageDiv.className = "";
          }, 5000);
        }

        function showLoading(show) {
          statusDiv.style.display = show ? "block" : "none";
        }

        searchButton.addEventListener("click", async () => {
          const query = searchQueryInput.value.trim();
          if (query === "") {
            showMessage("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm.", "error");
            return;
          }

          currentQuery = query;
          offset = 0;
          hasMore = true;
          tracksList.innerHTML = "";
          showMessage("", "");
          searchTracks(query, true);
        });

        window.addEventListener("scroll", () => {
          if (
            window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 &&
            !isLoading && hasMore
          ) {
            loadMoreTracks();
          }
        });

        function loadMoreTracks() {
          if (currentQuery === "") {
            const defaultQuery = "hay trao cho anh";
            searchTracks(defaultQuery, false);
          } else {
            searchTracks(currentQuery, false);
          }
        }

        getAccessToken();
      });
    </script>
  </body>
</html>
